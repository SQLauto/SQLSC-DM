SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO


CREATE PROCEDURE [Staging].[spLoadDMDownStreamMonthly_NonCum_James]
as
begin
	set nocount on
    
	truncate table Marketing.DMDownStreamMonthly_NonCum_James

	insert into Marketing.DMDownStreamMonthly_NonCum_James
	Select 
        a.Customerid,
        b.IntlOrderYear, 
        b.IntlOrderMonth,
        b.IntlAmount,
        DS_1_MoSales = sum(case when DOwnStreamDays <= 30 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
        DS_2_MoSales = SUM(case when DOwnStreamDays between 31 and 60 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_3_MoSales = SUM(case when DOwnStreamDays between 61 and 90 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_4_MoSales = SUM(case when DOwnStreamDays between 91 and 120 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_5_MoSales = SUM(case when DOwnStreamDays between 121 and 150 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_6_MoSales = SUM(case when DOwnStreamDays between 151 and 180 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_7_MoSales = SUM(case when DOwnStreamDays between 181 and 210 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_8_MoSales = SUM(case when DOwnStreamDays between 211 and 240 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_9_MoSales = SUM(case when DOwnStreamDays between 241 and 270 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_10_MoSales = SUM(case when DOwnStreamDays between 271 and 300 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_11_MoSales = SUM(case when DOwnStreamDays between 301 and 330 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_12_MoSales = SUM(case when DOwnStreamDays between 331 and 360 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_13_MoSales = SUM(case when DOwnStreamDays between 361 and 390 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_14_MoSales = SUM(case when DOwnStreamDays between 391 and 420 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_15_MoSales = SUM(case when DOwnStreamDays between 421 and 450 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_16_MoSales = SUM(case when DOwnStreamDays between 451 and 480 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_17_MoSales = SUM(case when DOwnStreamDays between 481 and 510 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_18_MoSales = SUM(case when DOwnStreamDays between 511 and 540 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_19_MoSales = SUM(case when DOwnStreamDays between 541 and 570 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_20_MoSales = SUM(case when DOwnStreamDays between 571 and 600 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_21_MoSales = SUM(case when DOwnStreamDays between 601 and 630 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_22_MoSales = SUM(case when DOwnStreamDays between 631 and 660 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_23_MoSales = SUM(case when DOwnStreamDays between 661 and 690 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_24_MoSales = SUM(case when DOwnStreamDays between 691 and 720 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_25_MoSales = SUM(case when DOwnStreamDays between 721 and 750 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_26_MoSales = SUM(case when DOwnStreamDays between 751 and 780 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_27_MoSales = SUM(case when DOwnStreamDays between 781 and 810 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_28_MoSales = SUM(case when DOwnStreamDays between 811 and 840 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_29_MoSales = SUM(case when DOwnStreamDays between 841 and 870 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_30_MoSales = SUM(case when DOwnStreamDays between 871 and 900 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_31_MoSales = SUM(case when DOwnStreamDays between 901 and 930 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_32_MoSales = SUM(case when DOwnStreamDays between 931 and 960 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_33_MoSales = SUM(case when DOwnStreamDays between 961 and 990 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_34_MoSales = SUM(case when DOwnStreamDays between 991 and 1020 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_35_MoSales = SUM(case when DOwnStreamDays between 1021 and 1050 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_36_MoSales = SUM(case when DOwnStreamDays between 1051 and 1080 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_37_MoSales = SUM(case when DOwnStreamDays between 1081 and 1110 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_38_MoSales = SUM(case when DOwnStreamDays between 1111 and 1140 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_39_MoSales = SUM(case when DOwnStreamDays between 1141 and 1170 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_40_MoSales = SUM(case when DOwnStreamDays between 1171 and 1200 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_41_MoSales = SUM(case when DOwnStreamDays between 1201 and 1230 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_42_MoSales = SUM(case when DOwnStreamDays between 1231 and 1260 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_43_MoSales = SUM(case when DOwnStreamDays between 1261 and 1290 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_44_MoSales = SUM(case when DOwnStreamDays between 1291 and 1320 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_45_MoSales = SUM(case when DOwnStreamDays between 1321 and 1350 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),
		DS_46_MoSales = SUM(case when DOwnStreamDays between 1351 and 1380 AND SequenceNum > 1 AND FinalSales < 1500 then FinalSales else 0 end),

        DS_1_MoOrders = sum(case when DOwnStreamDays <= 30 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_2_MoOrders = SUM(case when DOwnStreamDays between 31 and 60 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_3_MoOrders = SUM(case when DOwnStreamDays between 61 and 90 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_4_MoOrders = SUM(case when DOwnStreamDays between 91 and 120 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_5_MoOrders = SUM(case when DOwnStreamDays between 121 and 150 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_6_MoOrders = SUM(case when DOwnStreamDays between 151 and 180 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_7_MoOrders = SUM(case when DOwnStreamDays between 181 and 210 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_8_MoOrders = SUM(case when DOwnStreamDays between 211 and 240 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_9_MoOrders = SUM(case when DOwnStreamDays between 241 and 270 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_10_MoOrders = SUM(case when DOwnStreamDays between 271 and 300 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_11_MoOrders = SUM(case when DOwnStreamDays between 301 and 330 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_12_MoOrders = SUM(case when DOwnStreamDays between 331 and 360 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_13_MoOrders = SUM(case when DOwnStreamDays between 361 and 390 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_14_MoOrders = SUM(case when DOwnStreamDays between 391 and 420 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_15_MoOrders = SUM(case when DOwnStreamDays between 421 and 450 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_16_MoOrders = SUM(case when DOwnStreamDays between 451 and 480 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_17_MoOrders = SUM(case when DOwnStreamDays between 481 and 510 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_18_MoOrders = SUM(case when DOwnStreamDays between 511 and 540 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_19_MoOrders = SUM(case when DOwnStreamDays between 541 and 570 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_20_MoOrders = SUM(case when DOwnStreamDays between 571 and 600 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_21_MoOrders = SUM(case when DOwnStreamDays between 601 and 630 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_22_MoOrders = SUM(case when DOwnStreamDays between 631 and 660 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_23_MoOrders = SUM(case when DOwnStreamDays between 661 and 690 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_24_MoOrders = SUM(case when DOwnStreamDays between 691 and 720 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_25_MoOrders = SUM(case when DOwnStreamDays between 721 and 750 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_26_MoOrders = SUM(case when DOwnStreamDays between 751 and 780 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_27_MoOrders = SUM(case when DOwnStreamDays between 781 and 810 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_28_MoOrders = SUM(case when DOwnStreamDays between 811 and 840 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_29_MoOrders = SUM(case when DOwnStreamDays between 841 and 870 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_30_MoOrders = SUM(case when DOwnStreamDays between 871 and 900 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_31_MoOrders = SUM(case when DOwnStreamDays between 901 and 930 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_32_MoOrders = SUM(case when DOwnStreamDays between 931 and 960 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_33_MoOrders = SUM(case when DOwnStreamDays between 961 and 990 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_34_MoOrders = SUM(case when DOwnStreamDays between 991 and 1020 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_35_MoOrders = SUM(case when DOwnStreamDays between 1021 and 1050 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_36_MoOrders = SUM(case when DOwnStreamDays between 1051 and 1080 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_37_MoOrders = SUM(case when DOwnStreamDays between 1081 and 1110 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_38_MoOrders = SUM(case when DOwnStreamDays between 1111 and 1140 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_39_MoOrders = SUM(case when DOwnStreamDays between 1141 and 1170 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_40_MoOrders = SUM(case when DOwnStreamDays between 1171 and 1200 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_41_MoOrders = SUM(case when DOwnStreamDays between 1201 and 1230 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_42_MoOrders = SUM(case when DOwnStreamDays between 1231 and 1260 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_43_MoOrders = SUM(case when DOwnStreamDays between 1261 and 1290 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_44_MoOrders = SUM(case when DOwnStreamDays between 1291 and 1320 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_45_MoOrders = SUM(case when DOwnStreamDays between 1321 and 1350 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_46_MoOrders = SUM(case when DOwnStreamDays between 1351 and 1380 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),


        DS_1_MoBuyer = max(case when DOwnStreamDays <= 30 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end), 	
		DS_2_MoBuyer = max(case when DOwnStreamDays between 31 and 60 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_3_MoBuyer = max(case when DOwnStreamDays between 61 and 90 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_4_MoBuyer = max(case when DOwnStreamDays between 91 and 120 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_5_MoBuyer = max(case when DOwnStreamDays between 121 and 150 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_6_MoBuyer = max(case when DOwnStreamDays between 151 and 180 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_7_MoBuyer = max(case when DOwnStreamDays between 181 and 210 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_8_MoBuyer = max(case when DOwnStreamDays between 211 and 240 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_9_MoBuyer = max(case when DOwnStreamDays between 241 and 270 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_10_MoBuyer = max(case when DOwnStreamDays between 271 and 300 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_11_MoBuyer = max(case when DOwnStreamDays between 301 and 330 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_12_MoBuyer = max(case when DOwnStreamDays between 331 and 360 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_13_MoBuyer = max(case when DOwnStreamDays between 361 and 390 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_14_MoBuyer = max(case when DOwnStreamDays between 391 and 420 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_15_MoBuyer = max(case when DOwnStreamDays between 421 and 450 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_16_MoBuyer = max(case when DOwnStreamDays between 451 and 480 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_17_MoBuyer = max(case when DOwnStreamDays between 481 and 510 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_18_MoBuyer = max(case when DOwnStreamDays between 511 and 540 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_19_MoBuyer = max(case when DOwnStreamDays between 541 and 570 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_20_MoBuyer = max(case when DOwnStreamDays between 571 and 600 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_21_MoBuyer = max(case when DOwnStreamDays between 601 and 630 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_22_MoBuyer = max(case when DOwnStreamDays between 631 and 660 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_23_MoBuyer = max(case when DOwnStreamDays between 661 and 690 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_24_MoBuyer = max(case when DOwnStreamDays between 691 and 720 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_25_MoBuyer = max(case when DOwnStreamDays between 721 and 750 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_26_MoBuyer = max(case when DOwnStreamDays between 751 and 780 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_27_MoBuyer = max(case when DOwnStreamDays between 781 and 810 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_28_MoBuyer = max(case when DOwnStreamDays between 811 and 840 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_29_MoBuyer = max(case when DOwnStreamDays between 841 and 870 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_30_MoBuyer = max(case when DOwnStreamDays between 871 and 900 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_31_MoBuyer = max(case when DOwnStreamDays between 901 and 930 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_32_MoBuyer = max(case when DOwnStreamDays between 931 and 960 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_33_MoBuyer = max(case when DOwnStreamDays between 961 and 990 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_34_MoBuyer = max(case when DOwnStreamDays between 991 and 1020 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_35_MoBuyer = max(case when DOwnStreamDays between 1021 and 1050 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_36_MoBuyer = max(case when DOwnStreamDays between 1051 and 1080 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_37_MoBuyer = max(case when DOwnStreamDays between 1081 and 1110 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_38_MoBuyer = max(case when DOwnStreamDays between 1111 and 1140 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_39_MoBuyer = max(case when DOwnStreamDays between 1141 and 1170 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_40_MoBuyer = max(case when DOwnStreamDays between 1171 and 1200 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_41_MoBuyer = max(case when DOwnStreamDays between 1201 and 1230 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_42_MoBuyer = max(case when DOwnStreamDays between 1231 and 1260 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_43_MoBuyer = max(case when DOwnStreamDays between 1261 and 1290 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_44_MoBuyer = max(case when DOwnStreamDays between 1291 and 1320 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_45_MoBuyer = max(case when DOwnStreamDays between 1321 and 1350 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end),
		DS_46_MoBuyer = max(case when DOwnStreamDays between 1351 and 1380 AND SequenceNum > 1 AND FinalSales < 1500 then 1 else 0 end)
  -- into  Marketing.DMDownStreamMonthly_NonCum_James
    from Marketing.DMPurchaseOrders (nolock) a join
		(select Customerid, 
				YEAR(DAteordered) IntlOrderYear,
				MONTH(DAteordered) IntlOrderMonth,
				NetOrderAmount as IntlAmount, 
				CurrencyCode
		from DataWarehouse.Marketing.DMPurchaseOrders
		where SequenceNum =1
		and DateOrdered >= '1/1/2009'
		and BillingCountryCode like '%US%')b on A.customerid = b.CustomerID
    group by a.CustomerID, b.IntlOrderYear, b.IntlOrderMonth, b.IntlAmount    
end
GO
